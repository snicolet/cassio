UNIT UnitJanEndgameAlphaBeta;INTERFACE{$PRAGMAC align_array_members on }{$PRAGMAC align power }{$PRAGMAC options align= power }{$PRAGMAC function_align 16}{$ALIGN PowerPC}uses UnitJanEndgameData, UnitListeChaineeCasesVides;function JanEndgameAlphaBeta(alpha,beta:longint;JanData:JanDataRecPtr):longint;function LanceurJanEndgameAlphaBeta(var plat:plOthEndgame;couleur,ESprof,alpha,beta,diffPions:longint):longint;IMPLEMENTATION{$PRAGMAC align_array_members on }{$PRAGMAC align power }{$PRAGMAC options align= power }{$PRAGMAC function_align 16}{$ALIGN PowerPC}USES UnitRapportImplementation,UnitRapport;var PositionEtTraitDernierCoup:positionEtTraitRec;    procedure WriteCurrentState(s:string;alpha,beta:longint;JanData:JanDataRecPtr);begin  with JanData^ do    begin		  SetDeroulementAutomatiqueDuRapport(true);		  WritelnDansRapport('');		  WritelnStringAndJanDataDansRapport(s);		  WritelnNumDansRapport('nbVides=',JanEndgameDepth);		  WriteNumDansRapport('alpha=',alpha);		  WritelnNumDansRapport('  beta=',beta);		  WritelnNumDansRapport('  action_stack_ptr=',longint(action_stack_ptr));		  WriteNumDansRapport('  md_ptr=',longint(md_ptr));		  WriteNumDansRapport('  .actions=',md_ptr^.actions);		  WritelnNumDansRapport('  .prev_stns_ahead=',md_ptr^.previous_stns_ahead);		end;end;function JanEndgameAlphaBeta(alpha,beta:longint;JanData:JanDataRecPtr):longint;var celluleDansListeChaineeCasesVides:celluleCaseVideDansListeChaineePtr;    celluleDepart:celluleCaseVideDansListeChaineePtr;    iCourant,noteCourante,maxPourBestDefAlphaBetaJan,i:longint;    local_action_ptr:action_ptr;    aJoue:boolean;begin  with JanData^ do    begin		  inc(nodes);		  maxPourBestDefAlphaBetaJan := -noteMax;		  aJoue := false;		  celluleDepart := celluleCaseVideDansListeChaineePtr(@gTeteListeChaineeCasesVides);      celluleDansListeChaineeCasesVides := celluleDepart^.next;		  repeat 		    with celluleDansListeChaineeCasesVides^ do		      BEGIN		        if (move_if_possible[square][turn](JanData)) <> 0 then		          begin		          		            aJoue := true;		            JanEndgameDepth := JanEndgameDepth - 1;		            		            (*		            WriteCurrentState('apres move_is_possible('+CoupEnString(square,true)+')',alpha,beta,JanData);		            AttendFrappeClavier;		            *)		            		            previous^.next := next;		            next^.previous := previous;		            if (JanEndgameDepth=1) 		              then 		                begin		                  iCourant := gTeteListeChaineeCasesVides.next^.square;		                  noteCourante := -end_eval_1_ply[iCourant][turn](JanData);		                  inc(nodes);		                end		              else noteCourante := -JanEndgameAlphaBeta(-beta,-alpha,JanData);		            (* undo_last_move(JanData); *)		            local_action_ptr := action_stack_ptr;					      for i := md_ptr^.actions downto 1 do					        begin					          with local_action_ptr^ do					            line_address^ := previous_line_value;					          local_action_ptr := action_ptr(longint(local_action_ptr) - size_of_action_rec);					        end;					      action_stack_ptr := local_action_ptr;							  md_ptr := md_t_ptr(longint(md_ptr) - size_of_md_t_rec);							  with md_ptr^ do							    begin							      stns_ahead := previous_stns_ahead;							      turn       := previous_turn;							    end;							    		            JanEndgameDepth := JanEndgameDepth + 1;		            		            (*		            WriteCurrentState('apres undo_last_move('+CoupEnString(square,true)+')',alpha,beta,JanData);		            AttendFrappeClavier;		            *)		            		            previous^.next := celluleDansListeChaineeCasesVides;						    next^.previous := celluleDansListeChaineeCasesVides;						    						    if (noteCourante>maxPourBestDefAlphaBetaJan) then 		              begin		                maxPourBestDefAlphaBetaJan := noteCourante;								    if (noteCourante>alpha) then 				              begin				                alpha := noteCourante;				                if (alpha>=beta) then 				                  begin				                    JanEndgameAlphaBeta := alpha;				                    exit(JanEndgameAlphaBeta);				                  end;				              end;				          end;		          end;		        celluleDansListeChaineeCasesVides := next;		      END;    		  until celluleDansListeChaineeCasesVides = celluleDepart;		  		  if aJoue then		    begin		      JanEndgameAlphaBeta := maxPourBestDefAlphaBetaJan;		      exit(JanEndgameAlphaBeta);		    end;		    		  (*		  WriteCurrentState('passe ! ',alpha,beta,JanData);		  AttendFrappeClavier;		  *)		    		  (* pass *)		  turn := 1 - turn;		  stns_ahead := -stns_ahead;		  noteCourante := alpha; {swap : alpha <= -beta , beta <= -alpha}		  alpha := -beta;		  beta := -noteCourante;		  inc(nodes);		  		  (*		  WriteCurrentState('aprs passe ',alpha,beta,JanData);		  AttendFrappeClavier;		  *)		    		  celluleDepart := celluleCaseVideDansListeChaineePtr(@gTeteListeChaineeCasesVides);      celluleDansListeChaineeCasesVides := celluleDepart^.next;		  repeat 		    with celluleDansListeChaineeCasesVides^ do		      BEGIN		        if (move_if_possible[square][turn](JanData)) <> 0 then		          begin		            aJoue := true;		            JanEndgameDepth := JanEndgameDepth -1;		            		            (*		            WriteCurrentState('apres move_is_possible('+CoupEnString(square,true)+')',alpha,beta,JanData);		            AttendFrappeClavier;		            *)		            		            previous^.next := next;		            next^.previous := previous;		            if (JanEndgameDepth=1) 		              then 		                begin		                  iCourant := gTeteListeChaineeCasesVides.next^.square;		                  noteCourante := -end_eval_1_ply[iCourant][turn](JanData);		                  inc(nodes);		                end		              else noteCourante := -JanEndgameAlphaBeta(-beta,-alpha,JanData);		            (* undo_last_move(JanData); *)		            local_action_ptr := action_stack_ptr;					      for i := md_ptr^.actions downto 1 do					        begin					          with local_action_ptr^ do					            line_address^ := previous_line_value;					          local_action_ptr := action_ptr(longint(local_action_ptr) - size_of_action_rec);					        end;					      action_stack_ptr := local_action_ptr;							  md_ptr := md_t_ptr(longint(md_ptr) - size_of_md_t_rec);							  with md_ptr^ do							    begin							      stns_ahead := previous_stns_ahead;							      turn       := previous_turn;							    end;							    		            JanEndgameDepth := JanEndgameDepth +1;		            		            (*		            WriteCurrentState('apres undo_last_move('+CoupEnString(square,true)+')',alpha,beta,JanData);		            AttendFrappeClavier;		            *)		            		            previous^.next := celluleDansListeChaineeCasesVides;						    next^.previous := celluleDansListeChaineeCasesVides;						    						    						    if (noteCourante>maxPourBestDefAlphaBetaJan) then 		              begin		                maxPourBestDefAlphaBetaJan := noteCourante;								    if (noteCourante>alpha) then 				              begin				                alpha := noteCourante;				                if (alpha>=beta) then 				                  begin				                    JanEndgameAlphaBeta := -alpha;				                    exit(JanEndgameAlphaBeta);				                  end;				              end;				          end;		          end;		        celluleDansListeChaineeCasesVides := next;		      END;    		  until celluleDansListeChaineeCasesVides = celluleDepart;		  		  if aJoue then		    begin		      JanEndgameAlphaBeta := -maxPourBestDefAlphaBetaJan;		      exit(JanEndgameAlphaBeta);		    end;		    		  stns_ahead := -stns_ahead;		  turn := 1 - turn;		  		  (*		  WriteCurrentState('double passe !!',alpha,beta,JanData);		  AttendFrappeClavier;		  *)		  		  if stns_ahead>0 then 			   begin			     JanEndgameAlphaBeta := stns_ahead + JanEndgameDepth;			     exit(JanEndgameAlphaBeta);			   end;		  if stns_ahead<0 then 		    begin		      JanEndgameAlphaBeta := stns_ahead - JanEndgameDepth;		      exit(JanEndgameAlphaBeta);		    end;		  JanEndgameAlphaBeta := 0;		end;end;function LanceurJanEndgameAlphaBeta(var plat:plOthEndgame;couleur,ESprof,alpha,beta,diffPions:longint):longint;var note : longint;begin  {$UNUSED plat,couleur,ESprof,alpha,beta,diffPions,note}  LanceurJanEndgameAlphaBeta := -10000;    {$IFC USING_JAN_ENDGAME }  with JanGlobalData do    begin				  (*		  WritelnDansRapport('plateau recu en parametre : ');		  WritelnPositionEtTraitDansRapport(plat,couleur);		  WritelnNumDansRapport('diffPions=',diffPions);		  AttendFrappeClavier;		  *)		  PlatOthEndgameToJanData(plat,couleur);		  stns_ahead := diffPions;		  JanEndgameDepth := ESprof;		  reset_ptrs_for_jan_endgame;		  		  (*		  WriteCurrentState('avant JanEndgameAlphaBeta : ',alpha,beta,@JanGlobalData);		  AttendFrappeClavier;		  *)		  		  note := JanEndgameAlphaBeta(alpha,beta,@JanGlobalData);		  		  LanceurJanEndgameAlphaBeta := note;		  		  (*		  WritelnNumDansRapport('  ==>  note=',note);		  WriteCurrentState('apres JanEndgameAlphaBeta : ',alpha,beta,@JanGlobalData);		  AttendFrappeClavier;		  *)		      end;  {$ENDC}end;END.